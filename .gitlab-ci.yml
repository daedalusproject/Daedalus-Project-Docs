stages:
    - build
    - http2
    - docker_image
    - deploy

build_docs:
    stage: build
    image: daedalusproject/base_hugo:201903220605
    before_script:
        - git submodule sync --recursive
        - git submodule update --init --recursive
        - mkdir timestamp
        - DATESTRING=$(date +%Y%m%d%H%M)
        - echo $DATESTRING > timestamp/timestampfile
    script:
        - hugo --gc --minify -s .
    artifacts:
        paths:
        - public
        - timestamp
        expire_in: 5 minutes

get_http2_preload_links:
    stage: http2
    image: daedalusproject/base:201903220605
    script:
        - for link in $(grep -o "src=[^>]*>" public/index.html | sed 's/^src=\([^>]*\)>$/\1/'); do echo "add_header Link \"<$link>; rel=preload; as=script\";"; done > links
        - for link in $(grep -o "href=[^>]*.css" public/index.html | sed 's/^href=\([^>]*\)$/\1/'); do echo "add_header Link \"<$link>; rel=preload; as=style\";"; done >> links
        - for link in $(grep -o "href=[^>]*type=image" public/index.html | sed 's/^href=\([^ ]*\) type=image$/\1/'); do echo "add_header Link \"<$link>; rel=preload; as=image\";"; done >> links
    artifacts:
        paths:
        - public
        - links
        - timestamp
        expire_in: 5 minutes
    dependencies:
    - build_docs

create_develop_image:
    stage: docker_image
    image: docker:stable
    script:
        - IMAGENAME=daedalus-project-docs-develop
        - RELEASEDATE=$(date)
        - DATESTRING=$(cat timestamp/timestampfile)
        - docker build --network=host --no-cache -t "${IMAGENAME}" -f containers/develop/Dockerfile .
        - docker login --username "${DOCKERHUBUSER}" --password "${DOCKERHUBPASSWORD}"
        - docker create --name="${IMAGENAME}" -i "${IMAGENAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":latest
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${DATESTRING}"
        - docker commit -m "$RELEASEDATE" -a "Álvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" "${IMAGENAME}" daedalusproject/"${IMAGENAME}"
        - docker push daedalusproject/"${IMAGENAME}":latest
        - docker push daedalusproject/"${IMAGENAME}":"${DATESTRING}"
        - docker stop "${IMAGENAME}"
        - docker rm "${IMAGENAME}"
        - docker rmi "${IMAGENAME}"
    dependencies:
    - get_http2_preload_links
      #    only:
      #    - /^develop$/

deploy_develop_image:
    stage: deploy
    image: daedalusproject/base_kubectl
    script:
        - kubectl config set-cluster default --server=$KUBE_URL --certificate-authority=kubernetes/windmaker.pem
        - kubectl config set-credentials gitlab-daedalus-project-deployer --token=$KUBE_USER_TOKEN
        - kubectl config set-context default --cluster=default --user=gitlab-daedalus-project-deployer
        - kubectl config use-context default
        - kubectl get pods -n daedalus-project-docs-develop
        - kubectl get pods -n daedalus-project-docs
        - IMAGENAME=daedalus-project-docs-develop
        - RELEASEDATE=$(date)
        - DATESTRING=$(cat timestamp/timestampfile)
        - sed -i s/__IMAGE_TAG__/$DATESTRING/g kubernetes/develop/daedalus-project-docs-deplyment.yaml
        - cat kubernetes/develop/daedalus-project-docs-deplyment.yaml
        - echo $DATESTRING
    dependencies:
    - build_docs


create_release_image:
    stage: docker_image
    image: docker:stable
    script:
        - IMAGENAME=daedalus-project-docs
        - RELEASEDATE=$(date)
        - docker build --network=host --no-cache -t "${IMAGENAME}" -f containers/release/Dockerfile .
        - docker login --username "${DOCKERHUBUSER}" --password "${DOCKERHUBPASSWORD}"
        - docker create --name="${IMAGENAME}" -i "${IMAGENAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":latest
        - docker commit -m "$RELEASEDATE" -a "Álvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker push daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker push daedalusproject/"${IMAGENAME}":latest
        - docker stop "${IMAGENAME}"
        - docker rm "${IMAGENAME}"
        - docker rmi "${IMAGENAME}"
    dependencies:
    - get_http2_preload_links
    only:
    - /^v-.*$/
