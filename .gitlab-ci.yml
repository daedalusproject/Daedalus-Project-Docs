stages:
    - build
    - nginx_conf
    - docker_image
    - deploy

build_docs:
    stage: build
    image: daedalusproject/base_hugo:201904181205
    before_script:
        - git submodule sync --recursive
        - git submodule update --init --recursive
        - mkdir timestamp
        - DATESTRING=$(date +%Y%m%d%H%M)
        - echo $DATESTRING > timestamp/timestampfile
    script:
        - hugo --gc --minify -s .
    artifacts:
        paths:
        - public
        - timestamp
        expire_in: 5 minutes

configure_nginx:
    stage: nginx_conf
    image: daedalusproject/base_xml_utils:201904181205
    script:
        - utils/xml2preloadlinks.sh public/sitemap.xml
        - echo "set_real_ip_from  0.0.0.0/0;" > realip.conf
        - echo "real_ip_header    X-Forwarded-For;" >> realip.conf
        - echo "real_ip_recursive on;" >> realip.conf
    artifacts:
        paths:
        - public
        - vhostlocations.conf
        - realip.conf
        - timestamp
        expire_in: 5 minutes
    dependencies:
    - build_docs

create_nightly_image:
    stage: docker_image
    image: docker:stable
    script:
        - IMAGENAME=daedalus-project-docs-develop
        - RELEASEDATE=$(date)
        - DATESTRING=$(cat timestamp/timestampfile)
        - docker build --network=host --no-cache -t "${IMAGENAME}" -f containers/develop/Dockerfile .
        - docker login --username "${DOCKERHUBUSER}" --password "${DOCKERHUBPASSWORD}"
        - docker create --name="${IMAGENAME}" -i "${IMAGENAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":nightly
        - docker commit -m "$RELEASEDATE" -a "Álvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" "${IMAGENAME}" daedalusproject/"${IMAGENAME}"
        - docker push daedalusproject/"${IMAGENAME}":nightly
        - docker stop "${IMAGENAME}"
        - docker rm "${IMAGENAME}"
        - docker rmi "${IMAGENAME}"
    artifacts:
        paths:
        - timestamp
        expire_in: 5 minutes
    dependencies:
    - configure_nginx
    except:
    - /^develop$/
    - /^master$/
    - tags


create_develop_image:
    stage: docker_image
    image: docker:stable
    script:
        - IMAGENAME=daedalus-project-docs-develop
        - RELEASEDATE=$(date)
        - DATESTRING=$(cat timestamp/timestampfile)
        - docker build --network=host --no-cache -t "${IMAGENAME}" -f containers/develop/Dockerfile .
        - docker login --username "${DOCKERHUBUSER}" --password "${DOCKERHUBPASSWORD}"
        - docker create --name="${IMAGENAME}" -i "${IMAGENAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":latest
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${DATESTRING}"
        - docker commit -m "$RELEASEDATE" -a "Álvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" "${IMAGENAME}" daedalusproject/"${IMAGENAME}"
        - docker push daedalusproject/"${IMAGENAME}":latest
        - docker push daedalusproject/"${IMAGENAME}":"${DATESTRING}"
        - docker stop "${IMAGENAME}"
        - docker rm "${IMAGENAME}"
        - docker rmi "${IMAGENAME}"
    artifacts:
        paths:
        - timestamp
        expire_in: 5 minutes
    dependencies:
    - configure_nginx
    only:
    - /^develop$/

deploy_develop_image:
    stage: deploy
    image: daedalusproject/base_kubectl:201904181205
    script:
        - kubectl config set-cluster default --server=$KUBE_URL --certificate-authority=kubernetes/windmaker.pem
        - kubectl config set-credentials gitlab-daedalus-project-deployer --token=$KUBE_USER_TOKEN
        - kubectl config set-context default --cluster=default --user=gitlab-daedalus-project-deployer
        - kubectl config use-context default
        - DATESTRING=$(cat timestamp/timestampfile)
        - echo $DATESTRING
        - sed -i s/__IMAGE_TAG__/$DATESTRING/g kubernetes/develop/daedalus-project-docs-deplyment.yaml
        - kubectl apply -f kubernetes/develop/daedalus-project-docs-deplyment.yaml
        - kubectl apply -f kubernetes/develop/daedalus-project-docs-service.yaml
        - kubectl apply -f kubernetes/develop/ingress.yaml
    dependencies:
    - create_develop_image
    only:
    - /^develop$/

create_staging_image:
    stage: docker_image
    image: docker:stable
    script:
        - IMAGENAME=daedalus-project-docs-develop
        - RELEASEDATE=$(date)
        - DATESTRING=$(cat timestamp/timestampfile)
        - docker build --network=host --no-cache -t "${IMAGENAME}" -f containers/release/Dockerfile .
        - docker login --username "${DOCKERHUBUSER}" --password "${DOCKERHUBPASSWORD}"
        - docker create --name="${IMAGENAME}" -i "${IMAGENAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"-"${DATESTRING}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":latest
        - docker commit -m "$RELEASEDATE" -a "Álvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker push daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"-"${DATESTRING}"
        - docker push daedalusproject/"${IMAGENAME}":latest
        - docker stop "${IMAGENAME}"
        - docker rm "${IMAGENAME}"
        - docker rmi "${IMAGENAME}"
    artifacts:
        paths:
        - timestamp
        expire_in: 5 minutes
    dependencies:
    - configure_nginx
    only:
    - /^master$/

deploy_staging_image:
    stage: deploy
    image: daedalusproject/base_kubectl:201904181205
    script:
        - kubectl config set-cluster default --server=$KUBE_URL --certificate-authority=kubernetes/windmaker.pem
        - kubectl config set-credentials gitlab-daedalus-project-deployer --token=$KUBE_USER_TOKEN
        - kubectl config set-context default --cluster=default --user=gitlab-daedalus-project-deployer
        - kubectl config use-context default
        - DATESTRING=$(cat timestamp/timestampfile)
        - sed -i s/__IMAGE_TAG__/"${CI_COMMIT_REF_NAME}"-"${DATESTRING}"/g kubernetes/staging/daedalus-project-docs-deplyment.yaml
        - kubectl apply -f kubernetes/staging/daedalus-project-docs-deplyment.yaml
        - kubectl apply -f kubernetes/staging/daedalus-project-docs-service.yaml
        - kubectl apply -f kubernetes/staging/ingress.yaml
    dependencies:
    - create_staging_image
    only:
    - /^master$/

create_release_image:
    stage: docker_image
    image: docker:stable
    script:
        - IMAGENAME=daedalus-project-docs
        - RELEASEDATE=$(date)
        - docker build --network=host --no-cache -t "${IMAGENAME}" -f containers/release/Dockerfile .
        - docker login --username "${DOCKERHUBUSER}" --password "${DOCKERHUBPASSWORD}"
        - docker create --name="${IMAGENAME}" -i "${IMAGENAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker tag "${IMAGENAME}" daedalusproject/"${IMAGENAME}":latest
        - docker commit -m "$RELEASEDATE" -a "Álvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" "${IMAGENAME}" daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker push daedalusproject/"${IMAGENAME}":"${CI_COMMIT_REF_NAME}"
        - docker push daedalusproject/"${IMAGENAME}":latest
        - docker stop "${IMAGENAME}"
        - docker rm "${IMAGENAME}"
        - docker rmi "${IMAGENAME}"
    artifacts:
        paths:
        - timestamp
        expire_in: 5 minutes
    dependencies:
    - configure_nginx
    only:
    - tags

deploy_release_image:
    stage: deploy
    image: daedalusproject/base_kubectl:201904181205
    script:
        - kubectl config set-cluster default --server=$KUBE_URL --certificate-authority=kubernetes/windmaker.pem
        - kubectl config set-credentials gitlab-daedalus-project-deployer --token=$KUBE_USER_TOKEN
        - kubectl config set-context default --cluster=default --user=gitlab-daedalus-project-deployer
        - kubectl config use-context default
        - DATESTRING=$(cat timestamp/timestampfile)
        - sed -i s/__IMAGE_TAG__/${CI_COMMIT_REF_NAME}/g kubernetes/release/daedalus-project-docs-deplyment.yaml
        - kubectl apply -f kubernetes/release/daedalus-project-docs-deplyment.yaml
        - kubectl apply -f kubernetes/release/daedalus-project-docs-service.yaml
        - kubectl apply -f kubernetes/release/ingress.yaml
    dependencies:
    - build_docs
    only:
    - tags
